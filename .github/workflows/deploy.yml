name: Deploy to Home Lab

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite executar manualmente

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Docker Compose
        run: |
          echo "üöÄ Iniciando deploy..."
          # For√ßa rebuild para garantir que as altera√ß√µes no c√≥digo sejam aplicadas
          docker compose up -d --build --remove-orphans
      
      - name: Verify deployment
        run: |
          echo "Verificando containers..."
          docker compose ps
          
          # Verifica se os containers est√£o rodando (nomes atualizados do docker-compose.yml atual)
          if ! docker compose ps | grep -q "conekta-api.*Up"; then
            echo "‚ùå Container conekta-api n√£o est√° rodando!"
            docker compose logs api
            exit 1
          fi
          
          if ! docker compose ps | grep -q "conekta-manager.*Up"; then
            echo "‚ùå Container conekta-manager n√£o est√° rodando!"
            docker compose logs manager
            exit 1
          fi
          
          # Frontend ainda n√£o existe, descomentar quando Task 10-13 estiverem prontas
          # if ! docker compose ps | grep -q "conekta-web.*Up"; then
          #   echo "‚ùå Container conekta-web n√£o est√° rodando!"
          #   exit 1
          # fi
          
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
